<!DOCTYPE html>
<!-- QA dept. weekly report tool demo -->
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>일일리포트 작성지원도구</title>

    <!-- Babel (for JSX support in the browser) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
  </head>

  <body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
      import React from "https://esm.sh/react@19"
      import ReactDOMClient from "https://esm.sh/react-dom@19/client"

      const { useState, useEffect, useId } = React;
      const REPORT_ITEMS_KEY = 'weekly-report-items';
      const NAME_KEY = 'add-name-field';
      const PROJECT_KEY = 'add-project-field';
      const DESC_KEY = 'add-desc-field';

      const names = ["박선우"];
      const projectPreselect = ["Demo Project", "Other"];

      function App() {
        const [reportItems, setReportItems] = useState([]);

        // New report item fields (also used for editing)
        const [name, setName] = useState(names[0]);
        const [project, setProject] = useState(projectPreselect[0]);
        const [description, setDescription] = useState('');

        // Load saved report items on initial page load
        useEffect(() => {
          const storedItems = localStorage.getItem(REPORT_ITEMS_KEY);
          if (storedItems) {
            try {
              setReportItems(JSON.parse(storedItems));
            } catch (e) {
              console.error('Failed to parse stored reportItems:', e);
            }
          } else {
            console.log("No stored items.");
          }

          const storedName = localStorage.getItem(NAME_KEY);
          if (storedName) {
            setName(storedName);
          }

          const storedProject = localStorage.getItem(PROJECT_KEY);
          if (storedProject) {
            setProject(storedProject);
          }

          const storedDesc = localStorage.getItem(DESC_KEY);
          if (storedDesc) {
            setDescription(storedDesc);
          }
        }, []);

        // Save reported items on change
        useEffect(() => {
          localStorage.setItem(REPORT_ITEMS_KEY, JSON.stringify(reportItems));
        }, [reportItems]);

        // Save fields on change
        useEffect(() => {
          localStorage.setItem(NAME_KEY, name);
        }, [name]);

        useEffect(() => {
          localStorage.setItem(PROJECT_KEY, project);
        }, [project]);

        useEffect(() => {
          localStorage.setItem(DESC_KEY, description);
        }, [description]);

        return (
          <div className="max-w-4xl mx-auto px-8">
            <h1 className="text-3xl my-4">일일리포트 작성</h1>

            <Table
              reportItems={reportItems}
              setReportItems={setReportItems}
              setName={setName}
              setProject={setProject}
              setDescription={setDescription} />
            <span className="block mb-4">(팁: 아이템을 누르면 삭제하실 수 있고, 삭제된 아이템은 바로 편집할 수 있도록 필드에 다시 입력됩니다.)</span>

            <ReportForm
              className="mb-4"
              reportItems={reportItems}
              setReportItems={setReportItems}
              name={name}
              setName={setName}
              project={project}
              setProject={setProject}
              description={description}
              setDescription={setDescription}
            />

            <h2 className="text-2xl mb-4">JSON Webex로 보내기</h2>
            <RawJSONView reportItems={reportItems} setReportItems={setReportItems} className="mb-4" />

            <h2 className="text-2xl mb-4">팀원 JSON 병합</h2>
            <TeamJSONMerge reportItems={reportItems} setReportItems={setReportItems} className="mb-4" />
          </div>
        );
      }

      // Define default components here
      function LabeledCheckbox({children, ...props}) {
        const id = useId();

        return (
          <div className="flex flex-wrap items-center">
            <input
              className="transition-all accent-blue-500 w-4 h-4"
              id={id}
              type="checkbox"
              {...props}
            />
            <label className="ms-2" htmlFor={id}>{children}</label>
          </div>
        );
      }


      function TextArea({...props}) {
        return (
            <textarea
              className="font-mono w-full h-48 border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
              {...props}
            />
        );
      }

      function Button({type, children, className = '', ...props}) {
        const buttonColor = type === "danger" ? "red" : "blue";
        const disabled = props.disabled;

        return (
          <button
            className={`bg-${buttonColor}-500 text-white font-bold py-2 px-4 rounded hover:bg-${buttonColor}-600 ` +
              (disabled ? "opacity-50 cursor-not-allowed " : "") +
              className
            }
            {...props}
          >
            {children}
          </button>
        );
      }

      function Dropdown({className = '', ...props}) {
        return (
          <select
            className={"border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500 " + className}
            {...props}
          />
        );
      }

      function TextBox({className = '', ...props}) {
        return (
          <input
            className={"border border-gray-300 rounded-md py-2 px-4 focus:outline-none focus:ring-2 focus:ring-blue-500 " + className}
            {...props}
          />
        );
      }


      function RawJSONView({ reportItems, setReportItems, className = '' }) {
        // Convert current state into JSON (for export)
        const jsonText = JSON.stringify(reportItems, null, 2);

        // Handle user JSON edits
        const handleJsonChange = (e) => {
          let text = e.target.value;
          if (text === "") { text = "[]" }
          try {
            const parsed = JSON.parse(text);
            setReportItems(parsed);
          } catch (err) {
            alert('입력한 JSON이 올바르지 않습니다. 다시 확인해 주세요.');
          }
        };

        const clipboardCopy = () => {
          navigator.clipboard.writeText(jsonText);
          alert("복사되었습니다. Webex로 전송해주세요.");
        };


        return (
          <div className={className}>
            <TextArea
              value={jsonText}
              onChange={handleJsonChange}
            />
            <Button onClick={clipboardCopy}>클립보드에 복사</Button>
          </div>
        );
      }

      function TeamJSONMerge({ reportItems, setReportItems, className = '' }) {
        const [jsonText, setJsonText] = useState("");
        const [mergeHistory, setMergeHistory] = useState([]);

        const historyEmpty = mergeHistory.length === 0;
        const jsonTextEmpty = jsonText.length === 0;

        const startImport = (e) => {
          if (jsonTextEmpty) return;

          const previousItems = reportItems;
          try {
            const parsed = JSON.parse(jsonText);

            parsed.forEach(user => {
              const { name, projects } = user;
              projects.forEach(project => {
                const { name: projectName, items } = project;
                items.forEach(description => {
                  addNewItem(reportItems, setReportItems, name, projectName, description);
                });
              });
            });

            // Clear JSON after adding
            setJsonText("");
            // Store previous report items in merge history
            setMergeHistory([...mergeHistory, previousItems]);
          } catch (err) {
            alert('입력한 JSON이 올바르지 않습니다. 다시 확인해 주세요.');
          }
        };

        const undoHistory = () => {
          // Sanity check
          if (historyEmpty) return;

          if (typeof window !== 'undefined' && !confirm("마지막 병합 작업을 취소하시겠습니까?")) {
            return; // cancel
          }

          const newHistory = [...mergeHistory];

          setReportItems(mergeHistory.pop());
          newHistory.pop();
          setMergeHistory(newHistory);
        };

        const clipboardPaste = async () => {
          try {
            // Check if the Clipboard API is supported
            if (navigator.clipboard && navigator.clipboard.readText) {
              const text = await navigator.clipboard.readText();
              setJsonText(text);
            } else {
              console.error("이 브라우저는 이 기능을 지원하지 않습니다.");
            }
          } catch (err) {
            alert("오류가 발생했습니다.");
            console.error("Failed to read clipboard contents:", err);
          }
        };

        const handleKeyDown = (event) => {
          if (event.ctrlKey && event.key === "Enter") {
            event.preventDefault();
            startImport();
          } else if (event.ctrlKey && event.key === "z") {
            event.preventDefault();
            undoHistory();
          }
        };

        const undoHistoryHelpText = historyEmpty ?
          "현재 병합 내역이 비어있어 실행취소하실 수 없습니다." : "마지막 병합 작업을 실행취소하고 이전 단계로 되돌립니다.";
        const startImportHelpText = jsonTextEmpty ?
          "먼저 JSON을 입력해주세요." : "입력된 팀원의 JSON을 현재 JSON에 병합처리합니다.";

        return (
          <div className={className}>
            <TextArea
              value={jsonText}   
              onChange={e => setJsonText(e.target.value)}
              onKeyDown={handleKeyDown}
            />
            {/* Controls */}
            <div className="flex flex-wrap gap-2 justify-between">
              <Button onClick={clipboardPaste} className={"me-2"}>클립보드에서 붙여넣기</Button>
              <div className="flex flex-wrap gap-2">
                <Button type="danger" onClick={undoHistory} disabled={historyEmpty} title={undoHistoryHelpText}>실행 취소</Button>
                <Button onClick={startImport} disabled={jsonTextEmpty} title={startImportHelpText}>병합</Button>
              </div>
            </div>
          </div>
        );
      }

      function addNewItem(reportItems, setReportItems, name, project, description) {
        if (!name || !project || !description) return;

        // Clean up whitespace
        var name = name.trim();
        var project = project.trim();
        var description = description.trim();

        setReportItems(prev => {
          const updated = [...prev];
          const personIndex = updated.findIndex(item => item.name === name);

          const newProject = {
            name: project,
            items: [description]
          };

          if (personIndex === -1) {
            // New person
            updated.push({
              name,
              projects: [newProject]
            });
          } else {
            // Existing person
            const existingProjectIndex = updated[personIndex].projects.findIndex(
              p => p.name === project
            );

            if (existingProjectIndex === -1) {
              // New project
              updated[personIndex].projects.push(newProject);
            } else {
              // Add to existing project
              updated[personIndex].projects[existingProjectIndex].items.push(description);
            }
          }
          return updated;
        });
      }

      function sortBySeniority(reportItems) {
        // Create a name -> index map for fast lookup
        const orderMap = names.reduce((acc, name, index) => {
          acc[name] = index;
          return acc;
        }, {});

        // Return a new sorted array
        return [...reportItems].sort((a, b) => {
          const indexA = orderMap[a.name] ?? Infinity;
          const indexB = orderMap[b.name] ?? Infinity;
          return indexA - indexB;
        });
      }

      function sortByProject(reportItems) {
        // Create a project -> index map for fast lookup
        const projectOrderMap = projectPreselect.reduce((acc, project, index) => {
          acc[project] = index;
          return acc;
        }, {});

        return reportItems.map(item => ({
          ...item,
          projects: [...item.projects].sort((a, b) => {
            const indexA = projectOrderMap[a.name] ?? Infinity;
            const indexB = projectOrderMap[b.name] ?? Infinity;
            return indexA - indexB;
          })
        }));
      }

      function ReportForm({ reportItems, setReportItems, name, setName, project, setProject, description, setDescription, className = '' }) {
        const isValid = name && project && description;

        const handleAdd = () => {
          if (!isValid) return;
          addNewItem(reportItems, setReportItems, name, project, description);

          // Clear fields for next run
          setDescription('');
        }

        const handleEnter = (e) => {
          if (e.key !== "Enter") return;
          handleAdd();
        }

        const nameInNames = names.includes(name);
        const projectInPreselect = projectPreselect.includes(project);

        return (
          <div className={"flex flex-col flex-wrap gap-2 " + className}>
            <div className="flex flex-wrap items-baseline gap-2 justify-between">
              <div className="flex flex-wrap gap-2 items-baseline">
                <label className="font-bold" htmlFor="name-field">이름</label>
                <Dropdown
                  value={name}
                  onChange={e => setName(e.target.value)}
                  id="name-field"
                >
                  {names.map((name, index) => (
                    <option key={index} value={name}>
                      {name}
                    </option>
                  ))}
                  {!nameInNames && (
                    <option value={name}>{name}</option>
                  )}
                </Dropdown>
              </div>

              <div className="flex flex-wrap gap-2 items-baseline">
                <label className="font-bold" htmlFor="project-field">프로젝트</label>
                <Dropdown
                  value={project}
                  onChange={e => setProject(e.target.value)}
                  id="project-field"
                >
                  {projectPreselect.map((projectPre, index) => (
                    <option key={index} value={projectPre}>
                      {projectPre}
                    </option>
                  ))}
	          {!projectInPreselect && (
                    <option value={project}>직접입력</option>
                  )}
                </Dropdown>

                <TextBox
                  placeholder="프로젝트"
                  value={project}
                  onChange={e => setProject(e.target.value)}
                />
              </div>
            </div>

            <div className="flex flex-wrap gap-2">
              <TextBox
                className="flex-grow"
                placeholder="업무 내용"
                value={description}
                onChange={e => setDescription(e.target.value)}
                onKeyPress={handleEnter}
                autofocus
              />
              <Button onClick={handleAdd} disabled={!isValid}>추가</Button>
            </div>
          </div>
        );
      }

      function removeItem(data, nameIndex, projectIndex, itemIndex) {
        return data
          .map((person, pIdx) => {
            if (pIdx !== nameIndex) return person;
            const updatedProjects = person.projects
              .map((project, projIdx) => {
                if (projIdx !== projectIndex) return project;
                const updatedItems = project.items.filter((_, iIdx) => iIdx !== itemIndex);
                if (updatedItems.length === 0) return null;
                return { ...project, items: updatedItems };
              })
              .filter(project => project !== null);
            if (updatedProjects.length === 0) return null;
            return { ...person, projects: updatedProjects };
          })
          .filter(person => person !== null);
      }

      function Table({reportItems, setReportItems, setName, setProject, setDescription}) {
        const [futurePlansMode, setFuturePlansMode] = useState(false);
        const headingText = futurePlansMode ? "차주" : "금일";

        const [sortName, setSortName] = useState(true);
        const [sortProject, setSortProject] = useState(true);

        var sortedItems = reportItems;

	if (sortProject) sortedItems = sortByProject(sortedItems);
	if (sortName) sortedItems = sortBySeniority(sortedItems);

        const deleteItem = (person_idx, project_idx, job_idx) => {
          if (typeof window !== 'undefined' && !confirm("정말로 삭제하시겠어요? 선택하신 아이템은 다시 필드로 이동시킵니다.")) {
            return; // cancel
          }

          const targetPerson = sortedItems[person_idx];
          const targetProject = targetPerson["projects"][project_idx];
          const targetDescription = targetProject["items"][job_idx];

          setReportItems(removeItem(sortedItems, person_idx, project_idx, job_idx));

          setName(targetPerson["name"]);
          setProject(targetProject["name"]);
          setDescription(targetDescription);       
        };

        return (
          <div id="report-table">
            <div id="table-options" className="mb-4">
              <LabeledCheckbox
                checked={futurePlansMode}
                onChange={e => setFuturePlansMode(e.target.checked)}
              >
                차주 보고서 헤더
              </LabeledCheckbox>
              <LabeledCheckbox
                checked={sortName}
                onChange={e => setSortName(e.target.checked)}
              >
                이름 정렬
              </LabeledCheckbox>

              <LabeledCheckbox
                checked={sortProject}
                onChange={e => setSortProject(e.target.checked)}
              >
                프로젝트 정렬
              </LabeledCheckbox>
            </div>

            <table border="1" className="w-full border-collapse border border-black">
              <thead>
                <tr>
                  <th className="text-center border border-black p-2">이름</th>
                  <th className="text-center border border-black p-2">프로젝트</th>
                  <th className="text-center border border-black p-2">{headingText} 업무 내용</th>
                </tr>
              </thead>
              <tbody>
                {sortedItems.length === 0 ? (
                  <tr>
                    <td colSpan="3" className="text-center border border-black p-2">
                      아이템이 없습니다. 아래에서 추가하세요!
                    </td>
                  </tr>
                ) : (
                  sortedItems.map((person, person_idx) =>
                    person.projects.map((project, project_idx) => (
                      <tr key={person.name + project.name}>
                      {project_idx === 0 && (
                        <td className="border border-black p-2" rowSpan={person.projects.length}>{person.name}</td>
                      )}
                      <td className="border border-black p-2">{project.name}</td>
                      <td className="border border-black p-2">
                        <ul>
                          {project.items.map((item, job_idx) => (
                            <li
                              className="list-disc ms-5 cursor-pointer hover:text-gray-700"
                              key={job_idx}
                              onClick={e => { deleteItem(person_idx, project_idx, job_idx) }}
                            >
                              {item}
                            </li>
                          ))}
                        </ul>
                      </td>
                    </tr>
                  ))
                )
              )}
              </tbody>
            </table>
          </div>
        );
      }

      const rootElement = document.getElementById('root');
      const root = ReactDOMClient.createRoot(rootElement);
      root.render(<App />);
    </script>
  </body>
</html>